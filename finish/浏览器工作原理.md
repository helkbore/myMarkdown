# 浏览器工作原理(未完成)
February 11, 2018 9:24 AM






##  浏览器功能
浏览器的功能：将用户选择的web资源呈现出来，需要从服务器请求资源，并将其显示在浏览器窗口中，资源的格式通常是HTML，也包括PDF、image及其他格式，用户用URI来指定所请求资源的位置。

##  浏览器结构
###用户接口(用户界面) user interface
   地址栏、书签选项、前进后退、刷新、暂停、主页等窗口上除了网页显示区域以外的部分
   
### 浏览器引擎 browser engine
   查询与操作渲染引擎的接口
   
### 渲染引擎 rendering engine
   用来显示请求的内容, 例如，如果请求内容为html，它负责解析html及css，并将解析后的结果显示出来。
   
### 网络 networking
   用于网络请求，如HTTP请求，它包括平台无关的接口和各平台独立的实现
   
### UI后端 UI backend
   绘制基础元件，如组合框与对话框，提供平台无关的通用接口，底层使用操作系统的相应实现
   
### JS解释器 javascript interpreter
   用于解析执行Javascript代码　　
   
### 数据存储 data persistence
   属于持久层
   浏览器需要把所有数据存到硬盘上，如cookies  
   > HTML5定义了web database技术，这是一种轻量级完整的客户端存储技术

~~~mermaid
graph TD;
 A[user interface] --> B[browser engine];
 B[browser engine] --> C[rendering engine];
 C[rendering engine] --> D[networking];
 C[rendering engine] --> E[javascript interpreter];
 C[rendering engine] --> F[UI backend];
 A[user interface] --> F[UI backend]; 
 B[browser engine] --> G[data persistence];
 
~~~
##  渲染引擎
*firefox* 使用的是**geoko**
*Mozilla*  自主研发
*safari*和*chrome*使用的是**webkit **
*webkit*  为Linux研发的, 苹果移植


### 基本流程
   渲染引擎首先通过网络获得所请求文档的内容，通常以8k分块的方式完成
   解析html构建dom树->构造 ==render树== ->布局render树->绘制render树
   
   

   
### 详细流程
   + 渲染引擎开始解析html,并将标签转化为内容树中的dom节点。
   + 接着，解析外部css文件及style标签中的样式信息，这些样式信息以及html中的样式信息将被用来构建另一棵树-render树。
   + render树由一些包含css属性的矩形组成，它们将被按照正确的顺序显示到屏幕上。
   + render树构建好之后，将会执行布局过程，它将确定每个节点在屏幕上的确切坐标。
   + 再下一步就是绘制，即遍历render树，并使用UI后端层绘制每个节点。

### 特点
   为了更好的用户体验，渲染引擎将会尽可能早的将内容呈现到屏幕上，并不会等到所有的html都解析完成之后再去构建和布局render树，它是解析完一部分内容就显示一部分内容，同时，可能还在通过网络下载其余内容。
   
### 注意
   webkit中元素的定位称为布局，而gecko中称为回流。
   
## 解析与DOM树构建
### 解析
####解析器-词法分析器
+ 语法分析
+ 词法分析

解析是一个迭代的过程。通常，
+ 解析器会向词法分析器请求一个新标记，并尝试将其与某条语法规则进行匹配。如果发现了匹配规则，解析器会将一个对应于该标记的节点添加到解析树中，然后继续请求下一个标记。 
+ 如果没有规则与该标记匹配，解析器就会将标记存储到内部，并继续请求下一个标记，直至找到可与所有内部存储的标记匹配的规则。 
+ 如果没有规则(即没有找到相应的语法规则)，解析器就会引发一个异常。这意味着文档无效，包含语法错误。

### 转换
很多时候，解析树还不是最终结果。解析通常是在转换过程中使用的，而转换是指将输入文档转换成另一种格式。编译就是一个例子。编译器可将源代码编译成机器代码，具体过程是首先将源代码解析成解析树，然后将解析树翻译成机器代码文档。

### html解析
 1.  html不能被一般的自顶向下或者自底向上的解析器所解析的原因如下：
   * 这门语言本身的宽容特性
   * 浏览器对一些常见的非法html有容错机制
   * 解析过程是往复的，通常源码不会有解析过程中发生改变，但在html中，脚本标签包含document.write可能添加标签，这说明在解析过程中实际上修改了输入
   
 2. html5规范中描述了html的解析算法:包括两个阶段——符号化及构建树。
   + **符号化**  是词法分析的过程，将输入解析为符号，html的符号包括开始标签、结束标签、属性名及属性值   
   
   + 符号识别器识别出符号后，将其传递给**树构建**器，并读取下一个字符，以识别下一个符号，这样直到处理完所有输入。

### css解析
  - 特性：css解析属于上下文无关文法
  - 实现：
   * webkit使用flex和bison解析生成器从css语法文件中自动生成解析器。Bison创建一个自底向上的解析器，firefox使用自顶向下解析器。
   * 它们都将每个css文件解析为**样式表对象**，每个对象包含css规则，css规则对象包含选择器和声明对象，以及其他一些符合css语法的对象。
   
  - 处理脚本及样式表的顺序
   * 脚本：web的模式是同步的。开发者可以将脚本标识为**defer**,以使其*不阻塞文档解析*，并在文档解析结束后执行。
   * 预解析：当执行脚本时，另一个线程解析剩下的文档，并加载后面需要通过网络加载的资源。这种方式可以使资源并行加载从而使整体速度更快。
   * 样式表：脚本可能在文档的解析过程中请求样式信息，如果样式还没有加载和解析，脚本将得到错误的值，firefox在存在样式表还在加载和解析时阻塞所有的脚本，而chrome只在当脚本试图访问某些可能被未加载的样式表所影响的特定的样式属性时才阻塞这些脚本。

 
## 渲染树结构
## 布局
## 绘制painting

参考:   

[浏览器的工作原理](http://www.cnblogs.com/xiaohuochai/p/4741054.html) http://www.cnblogs.com/xiaohuochai/p/4741054.html
http://blog.csdn.net/dangnian/article/details/50876241